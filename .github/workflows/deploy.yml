name: deploy fyi-app to Fly.io

on:
   workflow_dispatch:

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                node-version: '18'

            - name: Install dependencies
              run: npm install

            - name: Build app
              run: npm run build

            - name: Install Fly CLI
              run: |
                curl -L https://fly.io/install.sh | sh
                echo "${HOME}/.fly/bin" >> $GITHUB_PATH

            - name: Deploy to Fly.io
              env: 
                FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
              run: fly deploy --app fyi-app --remote-only
            
            - name: Wait for app to be healthy
              run: |
                echo "Waiting for fyi-app to become healthy..."
                    for i in {1..10}; do
                    STATUS=$(fly status -a fyi-app --json | jq -r '.App.Status')
                    if [ "$STATUS" = "running" ]; then
                        echo "App is running and healthy."
                        exit 0
                    fi
                    echo "Still waiting... ($i/10)"
                    sleep 10
                    done
                    echo "App did not become healthy in time."
                    exit 1
